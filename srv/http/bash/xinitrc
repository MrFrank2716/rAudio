#!/bin/bash

mkdir -p /tmp/.cache

export XDG_CACHE_HOME=/tmp/.cache

for file in /etc/X11/xinit/xinitrc.d/*; do
	. "$file"
done

. /srv/http/data/system/localbrowser.conf

/srv/http/bash/settings/features.sh localbrowserxset

if [[ $cursor == true ]] || ! ifconfig | grep -q -m1 inet.*broadcast; then  # no network connection
	cursor=yes
else
	cursor=no
fi

matchbox-window-manager -use_cursor $cursor &

scale=$( awk 'BEGIN { printf "%.2f", '$zoom/100' }' )

if [[ -e /usr/bin/firefox ]]; then
	dirfirefox=/root/.mozilla/firefox
	[[ ! -e $dirfirefox ]] && timeout 1 firefox --headless
	profile=$( grep -m1 Default $dirfirefox/profiles.ini | cut -d= -f2 )
	fileuserjs=$dirfirefox/$profile/user.js
	if [[ $scale == 1.00 ]]; then
		rm -f $fileuserjs
	else
		echo 'user_pref("layout.css.devPixelsPerPx", "'$scale'");' > $fileuserjs
	fi
	firefox -kiosk http://localhost
else
	[[ $scale != 1.00 ]] && scalefactor=--force-device-scale-factor=$scale
	chromium localhost $scalefactor \
		--disable-software-rasterizer \
		--incognito \
		--kiosk \
		--no-sandbox
fi
