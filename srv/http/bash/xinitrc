#!/bin/bash

. /srv/http/data/system/localbrowser.conf

if [[ $runxinitrcd ]]; then
	for file in /etc/X11/xinit/xinitrc.d/*; do
		. "$file"
	done
fi

/srv/http/bash/settings/features.sh localbrowserxset

if ifconfig | grep -q -m1 inet.*broadcast; then
	[[ $cursor ]] && cursor=yes || cursor=no
else
	cursor=yes
fi
matchbox-window-manager -use_cursor $cursor &
rm -rf /root/.mozilla
timeout 1 firefox --headless &> /dev/null
for i in {1..5}; do
	[[ -e /root/.mozilla ]] && break || sleep 1
done
scale=$( awk 'BEGIN { printf "%.2f", '$zoom/100' }' )
if [[ $scale == 1.00 ]]; then
	rm -f $fileuserjs
else
	profile=$( grep -m1 ^Default /root/.mozilla/firefox/profiles.ini | cut -d= -f2 )
	fileuserjs=/root/.mozilla/firefox/$profile/user.js
	echo 'user_pref("layout.css.devPixelsPerPx", "'$scale'");' > $fileuserjs
fi
firefox -kiosk http://localhost
